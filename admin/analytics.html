<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Super Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>

<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>âš¡ SUPER ADMIN</h2>
                <p>Patagonia Automatiza</p>
            </div>
            <nav class="admin-menu">
                <a href="index.html" class="admin-menu-item"><i>ğŸ“Š</i><span>Dashboard</span></a>
                <a href="usuarios.html" class="admin-menu-item"><i>ğŸ‘¥</i><span>Usuarios</span></a>
                <a href="servicios.html" class="admin-menu-item"><i>ğŸš€</i><span>Servicios</span></a>
                <a href="facturas.html" class="admin-menu-item"><i>ğŸ’³</i><span>Facturas</span></a>
                <a href="analytics.html" class="admin-menu-item active"><i>ğŸ“ˆ</i><span>Analytics</span></a>
                <a href="notificaciones.html" class="admin-menu-item"><i>ğŸ“¢</i><span>Notificaciones</span></a>
                <a href="configuracion.html" class="admin-menu-item"><i>âš™ï¸</i><span>ConfiguraciÃ³n</span></a>
            </nav>
            <div class="admin-footer">
                <button class="btn btn-danger btn-sm w-100" id="admin-logout-btn">Cerrar SesiÃ³n</button>
            </div>
        </aside>
        <main class="admin-main">
            <header class="admin-header">
                <h1>Analytics y Reportes</h1>
                <div class="admin-user"><span id="admin-name">Admin</span>
                    <div class="admin-avatar">SA</div>
                </div>
            </header>
            <div class="admin-content">
                <div class="table-card">
                    <h3 class="config-header">ğŸ“Š Reportes RÃ¡pidos</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>ğŸ“ˆ Crecimiento de Usuarios</h4>
                            <p class="analytics-subtitle">Ãšltimos 6 meses</p>
                            <p class="analytics-value" id="user-growth">+0%</p>
                        </div>
                        <div class="analytics-card">
                            <h4>ğŸ’° Ingresos Totales</h4>
                            <p class="analytics-subtitle">Todo el tiempo</p>
                            <p class="analytics-value" id="total-revenue">$0</p>
                        </div>
                        <div class="analytics-card">
                            <h4>ğŸ¯ Tasa de Pago</h4>
                            <p class="analytics-subtitle">Facturas pagadas vs total</p>
                            <p class="analytics-value" id="payment-rate">0%</p>
                        </div>
                    </div>
                </div>
                <div class="table-card analytics-popular-section">
                    <h3 class="analytics-popular-title">ğŸš€ Servicio MÃ¡s Popular</h3>
                    <div id="popular-service" class="analytics-popular-content">Cargando...</div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/admin-auth.js"></script>
    <script>
        async function loadAnalytics() {
            try {
                const [users, invoices, services] = await Promise.all([
                    supabase.from('clientes').select('fecha_registro'),
                    supabase.from('facturas').select('monto, estado'),
                    supabase.from('servicios').select('tipo')
                ]);

                // Growth
                const now = new Date();
                const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                const newUsers = users.data.filter(u => new Date(u.fecha_registro) > sixMonthsAgo).length;
                const growth = users.data.length > 0 ? ((newUsers / users.data.length) * 100).toFixed(1) : 0;
                document.getElementById('user-growth').textContent = `+${growth}%`;

                // Revenue
                const totalRevenue = invoices.data.filter(i => i.estado === 'pagada').reduce((sum, i) => sum + i.monto, 0);
                document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;

                // Payment Rate
                const paidCount = invoices.data.filter(i => i.estado === 'pagada').length;
                const paymentRate = invoices.data.length > 0 ? ((paidCount / invoices.data.length) * 100).toFixed(1) : 0;
                document.getElementById('payment-rate').textContent = `${paymentRate}%`;

                // Popular Service
                const typeCounts = {};
                services.data.forEach(s => typeCounts[s.tipo] = (typeCounts[s.tipo] || 0) + 1);
                const popular = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('popular-service').textContent = popular ? `${popular[0]} (${popular[1]} servicios)` : 'No hay datos';

            } catch (error) {
                console.error('Error:', error);
            }
        }

        setTimeout(() => { if (currentAdmin) loadAnalytics(); }, 1000);
    </script>
</body>

</html>