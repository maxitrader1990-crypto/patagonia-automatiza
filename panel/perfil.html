<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Patagonia Automatiza</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/panel.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/toast.css">
</head>

<body>
    <div class="panel-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>PATAGONIA AUTOMATIZA</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i>ðŸ“Š</i> Dashboard
                </a>
                <a href="servicios.html" class="menu-item">
                    <i>ðŸš€</i> Mis Servicios
                </a>
                <a href="facturas.html" class="menu-item">
                    <i>ðŸ’³</i> Facturas
                </a>
                <a href="soporte.html" class="menu-item">
                    <i>ðŸŽ«</i> Soporte
                </a>
                <a href="perfil.html" class="menu-item active">
                    <i>ðŸ‘¤</i> Mi Perfil
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" id="logout-btn">Cerrar SesiÃ³n</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="hamburger-toggle" id="sidebar-toggle">â˜°</div>
                    <div class="notification-icon" id="notification-bell">
                        ðŸ””
                        <span class="notification-badge d-none" id="notification-count">0</span>
                        <div class="notification-dropdown" id="notification-dropdown">
                            <div class="notification-dropdown-header">
                                <h4>Notificaciones</h4>
                                <a href="#" class="mark-all-read" id="mark-all-read">Marcar todas como leÃ­das</a>
                            </div>
                            <div id="notification-list">
                                <div class="notification-empty">
                                    <p>No tienes notificaciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="user-avatar">
                        <div class="avatar-circle" id="user-initials">PA</div>
                        <span id="user-name">Usuario</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header animate-fade-in">
                    <h1>Mi Perfil</h1>
                    <p>Gestiona tu informaciÃ³n personal y configuraciÃ³n de la cuenta</p>
                </div>

                <!-- InformaciÃ³n Personal -->
                <div class="section-card animate-fade-in animate-delay-1">
                    <h3>ðŸ‘¤ InformaciÃ³n Personal</h3>
                    <form id="profile-form" class="profile-section">
                        <div class="profile-grid">
                            <div>
                                <label for="nombre" class="form-label">Nombre Completo</label>
                                <input type="text" id="nombre" class="form-input">
                            </div>
                            <div>
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" disabled class="form-input">
                            </div>
                            <div>
                                <label for="telefono" class="form-label">TelÃ©fono</label>
                                <input type="tel" id="telefono" class="form-input">
                            </div>
                            <div>
                                <label for="empresa" class="form-label">Empresa</label>
                                <input type="text" id="empresa" class="form-input">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn">Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Seguridad -->
                <div class="section-card animate-fade-in animate-delay-2">
                    <h3>ðŸ”’ Seguridad</h3>
                    <div class="profile-section">
                        <div class="profile-card">
                            <h4>Cambiar ContraseÃ±a</h4>
                            <p>Te enviaremos un email para restablecer tu contraseÃ±a</p>
                            <div class="mt-1">
                                <button class="btn btn-secondary" id="reset-password-btn">Restablecer
                                    ContraseÃ±a</button>
                            </div>
                        </div>
                        <div class="profile-card">
                            <h4>SesiÃ³n Activa</h4>
                            <p>Ãšltima conexiÃ³n: <span id="last-login">Cargando...</span></p>
                        </div>
                    </div>
                </div>

                <!-- InformaciÃ³n de la Cuenta -->
                <div class="section-card animate-fade-in animate-delay-3">
                    <h3>ðŸ“‹ InformaciÃ³n de la Cuenta</h3>
                    <div class="account-info-grid">
                        <div class="account-info-card">
                            <p class="form-label account-label">Cliente desde</p>
                            <p class="account-value" id="fecha-registro">-</p>
                        </div>
                        <div class="account-info-card">
                            <p class="form-label account-label">ID de Cliente</p>
                            <p class="account-value account-value-mono" id="cliente-id">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/5492944123456" target="_blank" rel="noopener" class="whatsapp-float">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"
        crossorigin="anonymous"></script>

    <!-- Scripts -->
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/toast.js"></script>
    <script src="../assets/js/panel.js"></script>
    <script src="../assets/js/notifications.js"></script>

    <script>
        // Cargar datos del perfil
        async function loadProfileData() {
            if (!currentUser) return;

            document.getElementById('nombre').value = currentUser.nombre || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('telefono').value = currentUser.telefono || '';
            document.getElementById('empresa').value = currentUser.empresa || '';
            document.getElementById('cliente-id').textContent = currentUser.id ? currentUser.id.substring(0, 8) + '...' : '-';

            if (currentUser.fecha_registro) {
                const fecha = new Date(currentUser.fecha_registro);
                document.getElementById('fecha-registro').textContent = fecha.toLocaleDateString('es-AR');
            }

            document.getElementById('last-login').textContent = new Date().toLocaleDateString('es-AR') + ' ' + new Date().toLocaleTimeString('es-AR');
        }

        // Guardar cambios en el perfil
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre = document.getElementById('nombre').value;
            const telefono = document.getElementById('telefono').value;
            const empresa = document.getElementById('empresa').value;

            try {
                const { error } = await supabase
                    .from('clientes')
                    .update({ nombre, telefono, empresa })
                    .eq('id', currentUser.id);

                if (error) throw error;

                toast.success('Perfil actualizado correctamente');
                currentUser = await getCurrentUserData();
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error al actualizar el perfil');
            }
        });

        // Cancelar ediciÃ³n
        document.getElementById('cancel-btn').addEventListener('click', () => {
            loadProfileData();
        });

        // Restablecer contraseÃ±a
        document.getElementById('reset-password-btn').addEventListener('click', async () => {
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(currentUser.email, {
                    redirectTo: window.location.origin + '/reset-password.html'
                });

                if (error) throw error;

                toast.success('Email de restablecimiento enviado. Revisa tu correo.');
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error al enviar email de restablecimiento');
            }
        });

        // Cargar datos cuando el DOM estÃ© listo
        setTimeout(() => {
            if (currentUser) {
                loadProfileData();
            }
        }, 500);
    </script>

</body>

</html>