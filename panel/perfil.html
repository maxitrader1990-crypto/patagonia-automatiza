<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Patagonia Automatiza</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/panel.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/toast.css">
</head>

<body>
    <div class="panel-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>PATAGONIA AUTOMATIZA</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i>ðŸ“Š</i> Dashboard
                </a>
                <a href="servicios.html" class="menu-item">
                    <i>ðŸš€</i> Mis Servicios
                </a>
                <a href="facturas.html" class="menu-item">
                    <i>ðŸ’³</i> Facturas
                </a>
                <a href="soporte.html" class="menu-item">
                    <i>ðŸŽ«</i> Soporte
                </a>
                <a href="perfil.html" class="menu-item active">
                    <i>ðŸ‘¤</i> Mi Perfil
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" id="logout-btn">Cerrar SesiÃ³n</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="hamburger-toggle" id="sidebar-toggle">â˜°</div>
                    <div class="notification-icon" id="notification-bell">
                        ðŸ””
                        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                        <div class="notification-dropdown" id="notification-dropdown">
                            <div class="notification-dropdown-header">
                                <h4>Notificaciones</h4>
                                <a href="#" class="mark-all-read" id="mark-all-read">Marcar todas como leÃ­das</a>
                            </div>
                            <div id="notification-list">
                                <div class="notification-empty">
                                    <p>No tienes notificaciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="user-avatar">
                        <div class="avatar-circle" id="user-initials">PA</div>
                        <span id="user-name">Usuario</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header animate-fade-in">
                    <h1>Mi Perfil</h1>
                    <p>Gestiona tu informaciÃ³n personal y configuraciÃ³n de la cuenta</p>
                </div>

                <!-- InformaciÃ³n Personal -->
                <div class="section-card animate-fade-in animate-delay-1">
                    <h3>ðŸ‘¤ InformaciÃ³n Personal</h3>
                    <form id="profile-form" style="margin-top: 1.5rem;">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label
                                    style="display: block; color: var(--gray); margin-bottom: 0.5rem; font-size: 0.9rem;">Nombre
                                    Completo</label>
                                <input type="text" id="nombre"
                                    style="width: 100%; padding: 0.8rem; background: var(--dark-alt); border: 1px solid rgba(100, 255, 218, 0.2); border-radius: 8px; color: var(--light); font-family: 'Outfit', sans-serif;">
                            </div>
                            <div>
                                <label
                                    style="display: block; color: var(--gray); margin-bottom: 0.5rem; font-size: 0.9rem;">Email</label>
                                <input type="email" id="email" disabled
                                    style="width: 100%; padding: 0.8rem; background: var(--dark); border: 1px solid rgba(100, 255, 218, 0.1); border-radius: 8px; color: var(--gray); font-family: 'Outfit', sans-serif; cursor: not-allowed;">
                            </div>
                            <div>
                                <label
                                    style="display: block; color: var(--gray); margin-bottom: 0.5rem; font-size: 0.9rem;">TelÃ©fono</label>
                                <input type="tel" id="telefono"
                                    style="width: 100%; padding: 0.8rem; background: var(--dark-alt); border: 1px solid rgba(100, 255, 218, 0.2); border-radius: 8px; color: var(--light); font-family: 'Outfit', sans-serif;">
                            </div>
                            <div>
                                <label
                                    style="display: block; color: var(--gray); margin-bottom: 0.5rem; font-size: 0.9rem;">Empresa</label>
                                <input type="text" id="empresa"
                                    style="width: 100%; padding: 0.8rem; background: var(--dark-alt); border: 1px solid rgba(100, 255, 218, 0.2); border-radius: 8px; color: var(--light); font-family: 'Outfit', sans-serif;">
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn">Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Seguridad -->
                <div class="section-card animate-fade-in animate-delay-2">
                    <h3>ðŸ”’ Seguridad</h3>
                    <div style="margin-top: 1.5rem;">
                        <div
                            style="padding: 1.5rem; background: var(--dark-alt); border-radius: 12px; border: 1px solid rgba(100, 255, 218, 0.1); margin-bottom: 1rem;">
                            <h4 style="color: var(--light); margin-bottom: 0.5rem;">Cambiar ContraseÃ±a</h4>
                            <p style="color: var(--gray); margin-bottom: 1rem; font-size: 0.9rem;">Te enviaremos un
                                email para restablecer tu contraseÃ±a</p>
                            <button class="btn btn-secondary" id="reset-password-btn">Restablecer ContraseÃ±a</button>
                        </div>
                        <div
                            style="padding: 1.5rem; background: var(--dark-alt); border-radius: 12px; border: 1px solid rgba(100, 255, 218, 0.1);">
                            <h4 style="color: var(--light); margin-bottom: 0.5rem;">SesiÃ³n Activa</h4>
                            <p style="color: var(--gray); font-size: 0.9rem;">Ãšltima conexiÃ³n: <span
                                    id="last-login">Cargando...</span></p>
                        </div>
                    </div>
                </div>

                <!-- InformaciÃ³n de la Cuenta -->
                <div class="section-card animate-fade-in animate-delay-3">
                    <h3>ðŸ“‹ InformaciÃ³n de la Cuenta</h3>
                    <div
                        style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: var(--dark-alt); border-radius: 8px;">
                            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.5rem;">Cliente desde</p>
                            <p style="color: var(--light); font-weight: 600;" id="fecha-registro">-</p>
                        </div>
                        <div style="padding: 1rem; background: var(--dark-alt); border-radius: 8px;">
                            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.5rem;">ID de Cliente</p>
                            <p style="color: var(--light); font-weight: 600; font-family: monospace; font-size: 0.85rem;"
                                id="cliente-id">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/5492944123456" target="_blank" rel="noopener" class="whatsapp-float">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"
        crossorigin="anonymous"></script>

    <!-- Scripts -->
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/toast.js"></script>
    <script src="../assets/js/panel.js"></script>
    <script src="../assets/js/notifications.js"></script>

    <script>
        // Cargar datos del perfil
        async function loadProfileData() {
            if (!currentUser) return;

            document.getElementById('nombre').value = currentUser.nombre || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('telefono').value = currentUser.telefono || '';
            document.getElementById('empresa').value = currentUser.empresa || '';
            document.getElementById('cliente-id').textContent = currentUser.id ? currentUser.id.substring(0, 8) + '...' : '-';

            if (currentUser.fecha_registro) {
                const fecha = new Date(currentUser.fecha_registro);
                document.getElementById('fecha-registro').textContent = fecha.toLocaleDateString('es-AR');
            }

            document.getElementById('last-login').textContent = new Date().toLocaleDateString('es-AR') + ' ' + new Date().toLocaleTimeString('es-AR');
        }

        // Guardar cambios en el perfil
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre = document.getElementById('nombre').value;
            const telefono = document.getElementById('telefono').value;
            const empresa = document.getElementById('empresa').value;

            try {
                const { error } = await supabase
                    .from('clientes')
                    .update({ nombre, telefono, empresa })
                    .eq('id', currentUser.id);

                if (error) throw error;

                toast.success('Perfil actualizado correctamente');
                currentUser = await getCurrentUserData();
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error al actualizar el perfil');
            }
        });

        // Cancelar ediciÃ³n
        document.getElementById('cancel-btn').addEventListener('click', () => {
            loadProfileData();
        });

        // Restablecer contraseÃ±a
        document.getElementById('reset-password-btn').addEventListener('click', async () => {
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(currentUser.email, {
                    redirectTo: window.location.origin + '/reset-password.html'
                });

                if (error) throw error;

                toast.success('Email de restablecimiento enviado. Revisa tu correo.');
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error al enviar email de restablecimiento');
            }
        });

        // Cargar datos cuando el DOM estÃ© listo
        setTimeout(() => {
            if (currentUser) {
                loadProfileData();
            }
        }, 500);
    </script>

</body>

</html>